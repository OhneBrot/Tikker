<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tikker – Preis-/Für Tikker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <!-- PWA & iOS -->
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <style>
    :root { --maxw: 430px; }
    body { background: #fafafa; }
    @media (prefers-color-scheme: dark){ body{ background:#0a0a0a; } }
    .card{ border-radius: 1.25rem; border:1px solid rgb(228,228,231); background:white; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    @media (prefers-color-scheme: dark){ .card{ background:#111; border-color:#27272a; } }
    .field{ border-radius: 1rem; border:1px solid rgb(212,212,216); background:white; }
    @media (prefers-color-scheme: dark){ .field{ background:#0b0b0b; border-color:#27272a; color:#e5e7eb; } }
    .muted{ color: #71717a; }
    @media (prefers-color-scheme: dark){ .muted{ color:#a1a1aa; } }
    .hiddenView{ display:none; }
    .tile{ aspect-ratio: 1/1; }

    /* Safe area for iPhone notch */
    .app {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    #app-root{ opacity:0; transform: translateX(24px); transition: transform .45s cubic-bezier(.22,.61,.36,1), opacity .45s ease; }
    #app-root.enter{ opacity:1; transform: translateX(0); }

    #app-loader{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(255,255,255,.92); z-index:50; transition:opacity .35s ease; pointer-events:none; }
    @media (prefers-color-scheme: dark){ #app-loader{ background:rgba(10,10,10,.92); } }
    .hub{ position:relative; width:140px; height:140px; }
    .hand{ position:absolute; left:50%; top:50%; width:92px; height:12px; transform-origin: 8px 50%; transform: translate(-50%,-50%) rotate(0deg); border-radius:999px; background: linear-gradient(145deg, rgba(255,255,255,0.45), rgba(255,255,255,0.08)); border:1px solid rgba(255,255,255,0.55); backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%); box-shadow: 0 10px 22px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.65), inset 0 -1px 0 rgba(255,255,255,.25); }
    .hand::after{ content:""; position:absolute; inset:0; border-radius:inherit; background: linear-gradient(120deg, rgba(255,255,255,.55) 0%, rgba(255,255,255,.15) 35%, rgba(255,255,255,0) 60%); mix-blend-mode:screen; opacity:.9; }
@keyframes hubTick { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }
.hub .hand.fallback-anim { animation: hubTick 1s steps(8,end) infinite; }
    @media (prefers-color-scheme: dark){ .hand{ background: linear-gradient(145deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)); border-color: rgba(255,255,255,0.28); box-shadow: 0 14px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.22), inset 0 -1px 0 rgba(255,255,255,.08);} .hand::after{ background: linear-gradient(120deg, rgba(255,255,255,.35) 0%, rgba(255,255,255,.12) 35%, rgba(255,255,255,0) 60%);} }

    .appbar{ backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.48)); border: 1px solid rgba(228,228,231,.6); box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    @media (prefers-color-scheme: dark){ .appbar{ background: linear-gradient(180deg, rgba(24,24,27,.55), rgba(24,24,27,.35)); border-color: rgba(63,63,70,.6); box-shadow: 0 8px 24px rgba(0,0,0,.35);} }

    .logo{ font-weight: 900; letter-spacing: .04em; line-height: 1; text-shadow: 0 10px 26px rgba(0,0,0,.3); }
    @media (prefers-color-scheme: dark){ .logo{ text-shadow: 0 10px 26px rgba(0,0,0,.45); } }
    .logo-icon{ width: 28px; height: 28px; flex-shrink:0; display:inline-block; background: linear-gradient(145deg, rgba(255,255,255,0.5), rgba(255,255,255,0.2)); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.4); border-radius: 50%; position: relative; box-shadow: inset 0 0 4px rgba(255,255,255,0.5), 0 2px 6px rgba(0,0,0,0.15); }
    .logo-icon::before{ content: ""; position:absolute; inset:4px; border: 2px solid rgba(0,0,0,0.5); border-radius:50%; }
    .logo-icon::after{ content: "€"; position:absolute; font-size:14px; color:rgba(0,0,0,0.65); top:50%; left:50%; transform:translate(-50%,-50%); }
    @media (prefers-color-scheme: dark){ .logo-icon{ background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border-color: rgba(255,255,255,0.15);} .logo-icon::before{ border-color: rgba(255,255,255,0.4);} .logo-icon::after{ color: rgba(255,255,255,0.8);} }

    @keyframes hubTick { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }
    @keyframes fadeOutHide { 0% { opacity:1; } 80% { opacity:0; } 100% { opacity:0; visibility:hidden; } }
    @keyframes appIn { from { opacity:0; transform: translateX(24px); } to { opacity:1; transform: translateX(0); } }

    /* Loader: always animates; if JS never runs, CSS fades it out automatically */
    .hub .hand { animation: hubTick 1s steps(8,end) infinite; }

    /* App entrance: CSS-only when body has .boot (default) */
    #app-root{ opacity:0; transform: translateX(24px); }
    body.boot #app-root{ animation: appIn .45s cubic-bezier(.22,.61,.36,1) .95s forwards; }

    /* CSS-only loader removal after ~1s + fade */
    body.boot #app-loader{ animation: fadeOutHide .6s ease 1.1s forwards; }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .hub .hand { animation-duration: 2s; }
      body.boot #app-root{ animation-duration: .001s; }
      body.boot #app-loader{ animation-duration: .001s; }
    }
  
    /* Safety: hidden overlays should never block input on iOS */
    .hidden, .hidden * { pointer-events: none !important; }

  </style>
</head>
<body class="min-h-screen boot">
  <div id="app-loader">
    <div id="hub" class="hub">
      <div class="hand" id="hand"></div>
    </div>
  </div>
  <script>try{var L=document.getElementById("app-loader");if(L){L.addEventListener("animationend",function(){if(getComputedStyle(L).visibility==="hidden"){L.remove();}});}}catch(e){}</script>

  <main id="app-root" class="app mx-auto min-h-screen max-w-[var(--maxw)] p-3 relative">
    <header class="sticky top-0 z-10 mb-3 rounded-3xl appbar p-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <button id="backBtn" aria-label="Zurück" class="hidden h-9 w-9 shrink-0 grid place-items-center rounded-2xl border border-zinc-300/60 text-zinc-700 dark:border-zinc-700/60 dark:text-zinc-200">←</button>
          <div class="flex items-center gap-2">
            <span class="logo-icon"></span>
            <div class="logo text-3xl tracking-wide text-zinc-900 dark:text-zinc-100">Tikker</div>
          </div>
        </div>
        <div class="relative">
          <button id="unitBtn" class="rounded-2xl border border-zinc-300/60 px-3 py-1.5 text-sm dark:border-zinc-700/60 bg-white/40 dark:bg-zinc-900/30">g ▾</button>
          <div id="unitModal" class="fixed inset-0 z-[70] hidden">
            <div id="unitBackdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(92vw,380px)]">
              <div class="relative appbar rounded-2xl p-4 shadow-xl overflow-hidden">
                <div class="mb-3 text-sm opacity-70">Einheit wählen</div>
                <div id="unitMenu" class="flex items-center gap-2">
                  <button data-unit="mg" class="px-3 py-1.5 rounded-full border border-zinc-300 dark:border-zinc-700">mg</button>
                  <span class="opacity-60">·</span>
                  <button data-unit="g"  class="px-3 py-1.5 rounded-full border border-zinc-300 dark:border-zinc-700">g</button>
                  <span class="opacity-60">·</span>
                  <button data-unit="kg" class="px-3 py-1.5 rounded-full border border-zinc-300 dark:border-zinc-700">kg</button>
                  <span class="opacity-60">·</span>
                  <button data-unit="T"  class="px-3 py-1.5 rounded-full border border-zinc-300 dark:border-zinc-700">T</button>
                </div>
                <div class="mt-3 flex items-center gap-2">
                  <button id="unitOk" class="px-3 py-1.5 rounded-full bg-black text-white dark:bg-zinc-100 dark:text-zinc-900">OK</button>
                  <button id="unitCancel" class="px-3 py-1.5 rounded-full border border-zinc-300 dark:border-zinc-700">Abbr.</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="views">
      <section id="view-home">
        <div class="grid grid-cols-2 gap-3">
          <button class="tile card p-3 text-left" onclick="setView('a')">
            <div class="mt-1 text-sm font-semibold">Für Kunden</div>
            <div class="text-xs muted">Budget + Preis → Menge</div>
          </button>
          <button class="tile card p-3 text-left" onclick="setView('b')">
            <div class="mt-1 text-sm font-semibold">Für Tikker</div>
            <div class="text-xs muted">Menge + Preis → Gesamt</div>
          </button>
          <button class="tile card p-3 text-left" onclick="setView('c')">
            <div class="mt-1 text-sm font-semibold">Kurs‑Rechner</div>
            <div class="text-xs muted">Budget + Menge → max €/Einheit</div>
          </button>
          <button class="tile card p-3 text-left" onclick="setView('d')">
            <div class="mt-1 text-sm font-semibold">Packungen & Einheiten</div>
            <div class="text-xs muted">Packpreis + Einheiten → €/Einheit</div>
          </button>
          <button class="col-span-2 card p-3 text-left flex items-center justify-between" onclick="setView('k')">
            <div>
              <div class="text-base font-semibold">K Liste</div>
              <div class="text-xs muted">Name, Datum, Stückzahl, Schulden, Anmerkungen</div>
            </div>
            <div class="text-xl">›</div>
          </button>
        </div>
        <p class="mt-4 text-center text-xs muted">Dezimal mit Komma (0,5). Dark Mode automatisch.</p>
      </section>

      <section id="view-a" class="hiddenView">
        <section class="card p-4">
          <h2 class="text-base font-semibold">Für Kunden</h2>
          <p class="mt-1 text-sm muted">Wie viele <span class="unitLabel">g</span> bekomme ich für mein Budget bei diesem Preis pro <span class="unitLabel">g</span>?</p>
          <div class="mt-3 flex flex-col gap-3">
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Budget</span>
              <div class="field flex items-center px-3 py-2">
                <input id="aBudget" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 24" />
                <span class="select-none pl-2 text-sm muted">€</span>
              </div>
            </label>
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Preis pro <span class="unitLabel">g</span></span>
              <div class="field flex items-center px-3 py-2">
                <input id="aPrice" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 7" />
                <span class="select-none pl-2 text-sm muted">€</span>
              </div>
            </label>
            <div class="rounded-2xl bg-zinc-100 p-3 text-sm dark:bg-zinc-900">
              <ul class="space-y-1">
                <li><span class="muted">Exakt: </span><b><span id="aExact">–</span> <span class="unitLabel">g</span></b></li>
                <li><span class="muted">Ganzzahl kaufbar (abrunden): </span><b><span id="aWhole">–</span> <span class="unitLabel">g</span></b></li>
                <li><span class="muted">Ausgegeben (ganzzahlig): </span><b id="aSpent">–</b></li>
                <li><span class="muted">Restgeld: </span><b id="aChange">–</b></li>
              </ul>
            </div>
          </div>
        </section>
      </section>

      <section id="view-b" class="hiddenView">
        <section class="card p-4">
          <h2 class="text-base font-semibold">Für Tikker</h2>
          <p class="mt-1 text-sm muted">Was kostet meine Zielmenge in <span class="unitLabel">g</span>?</p>
          <div class="mt-3 flex flex-col gap-3">
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Menge (<span class="unitLabel">g</span>)</span>
              <div class="field flex items-center px-3 py-2">
                <input id="bQty" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 50" />
              </div>
            </label>
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Preis pro <span class="unitLabel">g</span></span>
              <div class="field flex items-center px-3 py-2">
                <input id="bPrice" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 4" />
                <span class="select-none pl-2 text-sm muted">€</span>
              </div>
            </label>
            <div class="rounded-2xl bg-zinc-100 p-3 text-sm dark:bg-zinc-900">
              <div class="flex items-center justify-between"><span class="muted">Gesamtpreis</span><b id="bTotal">–</b></div>
            </div>
          </div>
        </section>
      </section>

      <section id="view-c" class="hiddenView">
        <section class="card p-4">
          <h2 class="text-base font-semibold">Kurs‑Rechner</h2>
          <p class="mt-1 text-sm muted">Welchen maximalen Preis pro <span class="unitLabel">g</span> darf ich zahlen?</p>
          <div class="mt-3 flex flex-col gap-3">
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Budget</span>
              <div class="field flex items-center px-3 py-2">
                <input id="cBudget" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 50" />
                <span class="select-none pl-2 text-sm muted">€</span>
              </div>
            </label>
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Zielmenge (<span class="unitLabel">g</span>)</span>
              <div class="field flex items-center px-3 py-2">
                <input id="cQty" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 10" />
              </div>
            </label>
            <div class="rounded-2xl bg-zinc-100 p-3 text-sm dark:bg-zinc-900">
              <div class="flex items-center justify-between"><span class="muted">Max. Preis pro <span class="unitLabel">g</span></span><b id="cMax">–</b></div>
            </div>
          </div>
        </section>
      </section>

      <section id="view-d" class="hiddenView">
        <section class="card p-4">
          <h2 class="text-base font-semibold">Packungen & Einheiten</h2>
          <p class="mt-1 text-sm muted">Packpreis & Einheiten/Pack → Preis pro <span class="unitLabel">g</span>. Mit Budget: wie viele Packs & Einheiten?</p>
          <div class="mt-3 flex flex-col gap-3">
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Packpreis</span>
              <div class="field flex items-center px-3 py-2">
                <input id="dPackPrice" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 12,99" />
                <span class="select-none pl-2 text-sm muted">€</span>
              </div>
            </label>
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Einheiten pro Pack (<span class="unitLabel">g</span>)</span>
              <div class="field flex items-center px-3 py-2">
                <input id="dUnitsPerPack" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 6" />
              </div>
            </label>
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Budget (optional)</span>
              <div class="field flex items-center px-3 py-2">
                <input id="dBudget" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="z. B. 40" />
                <span class="select-none pl-2 text-sm muted">€</span>
              </div>
            </label>
            <div class="rounded-2xl bg-zinc-100 p-3 text-sm dark:bg-zinc-900">
              <ul class="space-y-1">
                <li><span class="muted">Preis pro <span class="unitLabel">g</span>: </span><b id="dPerUnit">–</b></li>
                <li><span class="muted">Packs mit Budget (ganzzahlig): </span><b id="dPacksWhole">–</b></li>
                <li><span class="muted">Einheiten aus Budget: </span><b><span id="dUnits">–</span> <span class="unitLabel">g</span></b></li>
                <li><span class="muted">Restgeld: </span><b id="dChange">–</b></li>
              </ul>
            </div>
          </div>
        </section>
      </section>
    </div>

    <section id="view-k" class="hiddenView">
      <section class="card p-4">
        <h2 class="text-base font-semibold">K Liste</h2>
        <p class="mt-1 text-sm muted">Einträge speichern</p>
        <div class="mt-3 grid grid-cols-1 gap-3">
          <label class="flex w-full flex-col gap-1">
            <span class="text-xs muted">Name</span>
            <div class="field flex items-center px-3 py-2">
              <input id="kName" type="text" class="w-full bg-transparent text-base outline-none" placeholder="Name" />
            </div>
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Datum</span>
              <button id="kDateBtn" class="field w-full text-left px-3 py-2">Tag.Monat</button>
            </label>
            <label class="flex w-full flex-col gap-1">
              <span class="text-xs muted">Stückzahl</span>
              <div class="field flex items-center px-3 py-2">
                <input id="kQty" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="0" />
              </div>
            </label>
          </div>
          <label class="flex w-full flex-col gap-1">
            <span class="text-xs muted">Schulden</span>
            <div class="field flex items-center px-3 py-2">
              <input id="kDebt" inputmode="decimal" type="text" class="w-full bg-transparent text-base outline-none" placeholder="0,00" />
              <span class="select-none pl-2 text-sm muted">€</span>
            </div>
          </label>
          <label class="flex w-full flex-col gap-1">
            <span class="text-xs muted">Anmerkungen</span>
            <div class="field flex items-center px-3 py-2">
              <input id="kNote" type="text" class="w-full bg-transparent text-base outline-none" placeholder="Anmerkungen" />
            </div>
          </label>
          <div class="flex items-center gap-2">
            <button id="kAddBtn" class="px-4 py-2 rounded-xl bg-black text-white dark:bg-zinc-100 dark:text-zinc-900">Hinzufügen</button>
            <button id="kClearBtn" class="px-4 py-2 rounded-xl border border-zinc-300 dark:border-zinc-700">Leeren</button>
          </div>
        </div>
        <div class="mt-4 rounded-2xl bg-zinc-100 p-3 text-sm dark:bg-zinc-900 overflow-x-auto">
          <table class="w-full min-w-[600px] text-left">
            <thead class="text-xs muted">
              <tr>
                <th class="py-2 pr-3">Name</th>
                <th class="py-2 pr-3">Datum</th>
                <th class="py-2 pr-3">Stückzahl</th>
                <th class="py-2 pr-3">Schulden</th>
                <th class="py-2 pr-3">Anmerkungen</th>
                <th class="py-2 pr-3"></th>
              </tr>
            </thead>
            <tbody id="kRows"></tbody>
          </table>
        </div>
      </section>
    </section>

    <div id="kDateModal" class="fixed inset-0 z-[60] hidden">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
      <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(90vw,360px)]">
        <div class="relative appbar rounded-2xl p-4 shadow-xl">
          <div id="kDatePopover" class="flex items-center gap-2">
            <input id="kDay" inputmode="numeric" maxlength="2" class="w-12 field px-2 py-1 bg-transparent text-center" placeholder="TT" />
            <span class="opacity-60">.</span>
            <input id="kMonth" inputmode="numeric" maxlength="2" class="w-12 field px-2 py-1 bg-transparent text-center" placeholder="MM" />
            <button id="kDateOk" class="px-3 py-1 rounded-xl bg-black text-white text-sm dark:bg-zinc-100 dark:text-zinc-900">OK</button>
            <button id="kDateCancel" class="px-3 py-1 rounded-xl border border-zinc-300 text-sm dark:border-zinc-700">Abbr.</button>
          </div>
        </div>
      </div>
    </div>

    <div id="kClearModal" class="fixed inset-0 z-[60] hidden">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
      <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 appbar rounded-2xl p-5 w-[min(90vw,360px)] shadow-xl">
        <h3 class="text-base font-semibold mb-2">Alles löschen?</h3>
        <p class="text-sm muted mb-4">Die gesamte K Liste wird entfernt. Dies kann nicht rückgängig gemacht werden.</p>
        <div class="flex justify-end gap-2">
          <button id="kClearNo" class="px-4 py-2 rounded-xl border border-zinc-300 dark:border-zinc-700">Abbrechen</button>
          <button id="kClearYes" class="px-4 py-2 rounded-xl bg-red-600 text-white">Ja, löschen</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    const views = { home: document.getElementById('view-home'), a: document.getElementById('view-a'), b: document.getElementById('view-b'), c: document.getElementById('view-c'), d: document.getElementById('view-d'), k: document.getElementById('view-k') };
    const backBtn = document.getElementById('backBtn');
    const unitBtn = document.getElementById('unitBtn');
    const unitMenu = document.getElementById('unitMenu');
    const unitModal = document.getElementById('unitModal');
    const unitBackdrop = document.getElementById('unitBackdrop');
    const unitCancel = document.getElementById('unitCancel');
    const unitOk = document.getElementById('unitOk');
    const kDateModal = document.getElementById('kDateModal');

    function currentView(){ return Object.entries(views).find(([id,el])=>el && !el.classList.contains('hiddenView'))?.[0] || 'home'; }

    const nfEUR = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' });
    const nfNUM = new Intl.NumberFormat('de-DE', { maximumFractionDigits: 3 });
    function parseNum(v){ if(typeof v !== 'string') return NaN; v = v.replace(/\s/g,'').replace(',', '.'); return parseFloat(v); }
    function fmtMoney(n){ return isFinite(n) ? nfEUR.format(n) : '–'; }
    function fmtNum(n){ return isFinite(n) ? nfNUM.format(n) : '–'; }

    const UNIT_FACTOR = { mg: 0.001, g: 1, kg: 1000, T: 1000000 };
    let unit = 'g';
    function setUnit(u){ if(!UNIT_FACTOR[u]) return; const prev = unit; unit = u; document.querySelectorAll('.unitLabel').forEach(el => el.textContent = unit); convertOnUnitChange(prev, unit); computeAll(); if(unitBtn) unitBtn.textContent = unit + ' ▾'; }
    function convertOnUnitChange(from, to){
      if(from===to) return;
      const f = UNIT_FACTOR[from];
      const t = UNIT_FACTOR[to];
      const priceScale = t / f;
      const qtyScale   = f / t;
      const aP=document.getElementById('aPrice'); if(aP && aP.value){ const v=parseNum(aP.value); if(isFinite(v)) aP.value = String(v*priceScale).replace('.', ','); }
      const bP=document.getElementById('bPrice'); if(bP && bP.value){ const v=parseNum(bP.value); if(isFinite(v)) bP.value = String(v*priceScale).replace('.', ','); }
      const bQ=document.getElementById('bQty'); if(bQ && bQ.value){ const v=parseNum(bQ.value); if(isFinite(v)) bQ.value = String(v*qtyScale).replace('.', ','); }
      const cQ=document.getElementById('cQty'); if(cQ && cQ.value){ const v=parseNum(cQ.value); if(isFinite(v)) cQ.value = String(v*qtyScale).replace('.', ','); }
    }

    if(unitBtn){
      let pendingUnit = unit;
      const selClasses = ['bg-black','text-white','dark:bg-zinc-100','dark:text-zinc-900'];
      const highlight = (u)=>{
        document.querySelectorAll('#unitMenu [data-unit]').forEach(b=>{
          selClasses.forEach(c=>b.classList.remove(c));
          if(b.dataset.unit===u){ selClasses.forEach(c=>b.classList.add(c)); }
        });
      };
      unitBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        pendingUnit = unit;
        highlight(pendingUnit);
        if(unitModal) unitModal.classList.remove('hidden');
      });
      const closeUnit = ()=>{ if(unitModal) unitModal.classList.add('hidden'); };
      if(unitCancel) unitCancel.addEventListener('click', closeUnit);
      if(unitOk) unitOk.addEventListener('click', ()=>{ setUnit(pendingUnit); closeUnit(); });
      if(unitBackdrop) unitBackdrop.addEventListener('click', closeUnit);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeUnit(); });
      if(unitMenu){ unitMenu.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-unit]'); if(!b) return; pendingUnit=b.dataset.unit; highlight(pendingUnit); setUnit(b.dataset.unit); closeUnit(); }); }
    }

    function setView(id){ Object.values(views).forEach(v => v.classList.add('hiddenView')); if(views[id]){ views[id].classList.remove('hiddenView'); } if(backBtn){ backBtn.classList.toggle('hidden', id === 'home'); } location.hash = '#' + id; if(id==='k'){ kBind(); kRender(); } computeAll(); }
    if(backBtn){ backBtn.addEventListener('click', ()=>{ if(currentView()==='k'){ kResetInputs(); } setView('home'); }); }
    window.addEventListener('hashchange', ()=>{ const id = location.hash.replace('#',''); if(views[id]) setView(id); });

    function computeA(){ const budget = parseNum((document.getElementById('aBudget')||{}).value || ''); const price = parseNum((document.getElementById('aPrice')||{}).value || ''); const exact = budget/price; const whole = Math.floor(exact); const spent = whole * price; const change = budget - spent; const aExact = document.getElementById('aExact'); const aWhole = document.getElementById('aWhole'); const aSpent = document.getElementById('aSpent'); const aChange = document.getElementById('aChange'); if(aExact) aExact.textContent = fmtNum(exact); if(aWhole) aWhole.textContent = isFinite(whole) ? nfNUM.format(whole) : '–'; if(aSpent) aSpent.textContent = fmtMoney(spent); if(aChange) aChange.textContent = fmtMoney(change); }
    function computeB(){ const qty = parseNum((document.getElementById('bQty')||{}).value || ''); const price = parseNum((document.getElementById('bPrice')||{}).value || ''); const total = qty * price; const bTotal = document.getElementById('bTotal'); if(bTotal) bTotal.textContent = fmtMoney(total); }
    function computeC(){ const budget = parseNum((document.getElementById('cBudget')||{}).value || ''); const qty = parseNum((document.getElementById('cQty')||{}).value || ''); const max = budget / qty; const cMax = document.getElementById('cMax'); if(cMax) cMax.textContent = isFinite(max) ? nfEUR.format(max) : '–'; }
    function computeD(){ const packPrice = parseNum((document.getElementById('dPackPrice')||{}).value || ''); const unitsPerPack = parseNum((document.getElementById('dUnitsPerPack')||{}).value || ''); const budget = parseNum((document.getElementById('dBudget')||{}).value || ''); const perUnit = packPrice / unitsPerPack; const dPerUnit = document.getElementById('dPerUnit'); const dPacksWhole = document.getElementById('dPacksWhole'); const dUnits = document.getElementById('dUnits'); const dChange = document.getElementById('dChange'); if(dPerUnit) dPerUnit.textContent = isFinite(perUnit) ? nfEUR.format(perUnit) : '–'; const packsWhole = Math.floor(budget / packPrice); if(dPacksWhole) dPacksWhole.textContent = isFinite(packsWhole) ? nfNUM.format(packsWhole) : '–'; const unitsCalc = Math.floor(budget / perUnit); if(dUnits) dUnits.textContent = isFinite(unitsCalc) ? nfNUM.format(unitsCalc) : '–'; const change = budget - (isFinite(unitsCalc) ? unitsCalc * perUnit : NaN); if(dChange) dChange.textContent = fmtMoney(change); }
    function computeAll(){ computeA(); computeB(); computeC(); computeD(); }

    function bindInputs(){ ['aBudget','aPrice','bQty','bPrice','cBudget','cQty','dPackPrice','dUnitsPerPack','dBudget'].forEach(id=>{ const el = document.getElementById(id); if(!el) return; el.addEventListener('input', computeAll); el.addEventListener('change', computeAll); }); }

    async function startLoader(){
      const loader = document.getElementById('app-loader');
      const app = document.getElementById('app-root');
      // Remove boot class so CSS animations won't re-trigger on re-entries
      document.body.classList.remove('boot');
      // If loader exists, fade it quickly via JS (overrides CSS timing)
      if(loader){
        loader.style.transition = 'opacity .25s ease';
        loader.style.opacity = '0';
        loader.style.pointerEvents = 'none';
        setTimeout(()=>{ if(loader && loader.parentNode) loader.remove(); }, 260);
      }
      // Ensure app is visible (in case CSS was blocked)
      if(app){
        app.style.opacity = '1';
        app.style.transform = 'translateX(0)';
      }
    }

      // Start CSS fallback immediately (in case rAF is throttled on iOS before first interaction)
      hand.classList.add('fallback-anim');

      let start = null;
      const steps = 8;
      const duration = 960; // ms
      let rafId = null;

      const loop = (t)=>{
        if(!start) start = t;
        const elapsed = t - start;
        const progress = Math.min(elapsed / duration, 1);
        const step = Math.floor(progress * steps) % steps;
        const angle = step * (360/steps);
        hand.style.transform = `translate(-50%,-50%) rotate(${angle}deg)`;
        if(progress < 1){
          rafId = requestAnimationFrame(loop);
        } else {
          // one full spin done
          finish();
        }
      };

      function finish(){
        if(rafId) cancelAnimationFrame(rafId);
        hand.classList.remove('fallback-anim'); // stop CSS fallback if it was running
        if(app) app.classList.add('enter');
        loader.style.opacity = '0';
        loader.style.pointerEvents = 'none';
        setTimeout(()=>{ loader.remove(); }, 220);
      }

      // Kick the rAF; also set a hard timeout as failsafe
      try { rafId = requestAnimationFrame(loop); } catch(e) { /* ignore */ }
      setTimeout(()=>{ if(document.getElementById('app-loader')) finish(); }, 1800);
    }

    function runTests(){
      const $ = (id)=>document.getElementById(id);
      console.group('Tests');
      console.assert($('#view-home') !== null, 'view-home fehlt');
      console.assert(document.getElementById('unitBtn') !== null, 'unitBtn fehlt');
      console.assert($('#backBtn') !== null, 'backBtn fehlt');
      const prev = { aBudget: ($('#aBudget')||{}).value || '', aPrice: ($('#aPrice')||{}).value || '', bQty: ($('#bQty')||{}).value || '', bPrice: ($('#bPrice')||{}).value || '', unit: unit};
      try{
        if($('#aBudget')) $('#aBudget').value = '24';
        if($('#aPrice')) $('#aPrice').value = '7';
        computeAll();
        console.assert($('#aExact') && $('#aExact').textContent !== '–', 'A: aExact wurde nicht berechnet');
        const unitBtnEl = document.getElementById('unitBtn');
        if(unitBtnEl){ unitBtnEl.click(); const gOpt = Array.from(document.querySelectorAll('#unitMenu [data-unit]')).find(b=>b.dataset.unit==='g'); if(gOpt){ gOpt.click(); console.assert(unit==='g', 'Einheit g nicht gesetzt'); } }
        if($('#bQty')) $('#bQty').value = '50';
        if($('#bPrice')) $('#bPrice').value = '4';
        computeAll();
        if($('#bTotal')) console.assert(/€/.test($('#bTotal').textContent), 'B: bTotal ohne €');
      } finally {
        if($('#aBudget')) $('#aBudget').value = prev.aBudget;
        if($('#aPrice')) $('#aPrice').value = prev.aPrice;
        if($('#bQty')) $('#bQty').value = prev.bQty;
        if($('#bPrice')) $('#bPrice').value = prev.bPrice;
        setUnit(prev.unit);
        computeAll();
      }
      try{
        const current = Object.entries(views).find(([id,el])=>el && !el.classList.contains('hiddenView'))?.[0] || 'home';
        setView('k');
        const before = (document.querySelectorAll('#kRows tr')||[]).length;
        const nameEl = document.getElementById('kName');
        const qtyEl = document.getElementById('kQty');
        const debtEl = document.getElementById('kDebt');
        if(nameEl) nameEl.value = 'Test';
        const dateBtn = document.getElementById('kDateBtn'); if(dateBtn){ dateBtn.dataset.value = '01.01'; dateBtn.textContent = '01.01'; }
        if(qtyEl) qtyEl.value = '3';
        if(debtEl) debtEl.value = '2,50';
        const add = document.getElementById('kAddBtn'); if(add) add.click();
        const after = (document.querySelectorAll('#kRows tr')||[]).length;
        console.assert(after === before + 1, 'K: Eintrag wurde nicht hinzugefügt');
        const firstQuitt = document.querySelector('#kRows .kDel'); if(firstQuitt){ firstQuitt.click(); }
        setView(current);
      } catch(e) {
        console.warn('K-Tests übersprungen/fehlschlag:', e);
      }
      const qBefore = parseNum((document.getElementById('bQty')||{}).value||'2');
      const pBefore = parseNum((document.getElementById('bPrice')||{}).value||'10');
      setUnit('kg');
      const qAfter = parseNum((document.getElementById('bQty')||{}).value||'');
      const pAfter = parseNum((document.getElementById('bPrice')||{}).value||'');
      console.assert(isFinite(qAfter) && Math.abs(qAfter - qBefore/1000) < 1e-6, 'Mengen‑Konvertierung g→kg falsch');
      console.assert(isFinite(pAfter) && Math.abs(pAfter - pBefore*1000) < 1e-6, 'Preis‑Konvertierung g→kg falsch');
      setUnit('g');
      console.assert(document.getElementById('app-loader')===null, 'Loader nicht entfernt');
      console.groupEnd();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      bindInputs(); setUnit('g'); setView('home'); await startLoader(); runTests();

      // SW registration (safe, ignores on file://)
      if ('serviceWorker' in navigator) {
        try { await navigator.serviceWorker.register('sw.js'); } catch (e) { console.warn('SW registration failed', e); }
      }
    });

    function kResetInputs(){
      const name=document.getElementById('kName');
      const qty=document.getElementById('kQty');
      const debt=document.getElementById('kDebt');
      const note=document.getElementById('kNote');
      const dateBtn=document.getElementById('kDateBtn');
      if(name) name.value='';
      if(qty) qty.value='';
      if(debt) debt.value='';
      if(note) note.value='';
      if(dateBtn){ dateBtn.textContent='Tag.Monat'; delete dateBtn.dataset.value; }
    }

    const K_KEY = 'tikker_klist';
    function kLoad(){ try{ return JSON.parse(localStorage.getItem(K_KEY)||'[]'); }catch(e){ return []; } }
    function kSave(data){ localStorage.setItem(K_KEY, JSON.stringify(data)); }
    function kRender(){ const rows = document.getElementById('kRows'); if(!rows) return; const data = kLoad(); rows.innerHTML = data.map((it,idx)=>`<tr class="border-t border-zinc-200 dark:border-zinc-800">
      <td class="py-2 pr-3">\${it.name||''}</td>
      <td class="py-2 pr-3">\${it.date||''}</td>
      <td class="py-2 pr-3">\${isFinite(it.qty)? nfNUM.format(it.qty): (it.qty??'')}</td>
      <td class="py-2 pr-3">\${isFinite(it.debt)? nfEUR.format(it.debt): (it.debt??'')}</td>
      <td class="py-2 pr-3">\${it.note||''}</td>
      <td class="py-2 pr-3 text-right">
        <button data-idx="\${idx}" class="kDel px-3 py-1.5 text-xs rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white shadow">Quitt</button>
      </td>
    </tr>`).join(''); rows.querySelectorAll('.kDel').forEach(btn=>btn.addEventListener('click',()=>{ const data=kLoad(); const i=+btn.dataset.idx; data.splice(i,1); kSave(data); kRender(); })); }
    function kAdd(){ const name=(document.getElementById('kName')||{}).value||''; const date=(document.getElementById('kDateBtn')||{}).dataset.value||''; const qty=parseNum((document.getElementById('kQty')||{}).value||''); const debt=parseNum((document.getElementById('kDebt')||{}).value||''); const note=(document.getElementById('kNote')||{}).value||''; const data=kLoad(); data.push({name, date, qty: isFinite(qty)? qty: null, debt: isFinite(debt)? debt: null, note}); kSave(data); kRender(); }
    function kClear(){ kSave([]); kRender(); }
    function kOpenClear(){ const m=document.getElementById('kClearModal'); if(!m) return; m.classList.remove('hidden'); }
    function kCloseClear(){ const m=document.getElementById('kClearModal'); if(!m) return; m.classList.add('hidden'); }
    function kBind(){
      const add=document.getElementById('kAddBtn');
      if(add && !add.dataset.bound){ add.dataset.bound='1'; add.addEventListener('click', kAdd); }
      const clr=document.getElementById('kClearBtn');
      if(clr && !clr.dataset.bound){ clr.dataset.bound='1'; clr.addEventListener('click', kOpenClear); }
      const yes=document.getElementById('kClearYes');
      if(yes && !yes.dataset.bound){ yes.dataset.bound='1'; yes.addEventListener('click', ()=>{ kClear(); kCloseClear(); }); }
      const no=document.getElementById('kClearNo');
      if(no && !no.dataset.bound){ no.dataset.bound='1'; no.addEventListener('click', kCloseClear); }
      const modal=document.getElementById('kClearModal');
      if(modal && !modal.dataset.bound){ modal.dataset.bound='1'; modal.addEventListener('click', (e)=>{ if(e.target===modal) kCloseClear(); }); }
      const dateBtn=document.getElementById('kDateBtn');
      if(dateBtn && !dateBtn.dataset.bound){
        dateBtn.dataset.bound='1';
        dateBtn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const pop=document.getElementById('kDatePopover'); if(!pop) return;
          if(kDateModal) kDateModal.classList.remove('hidden');
          const d=document.getElementById('kDay'); const m=document.getElementById('kMonth'); if(d) d.focus();
          const ok=document.getElementById('kDateOk'); const cancel=document.getElementById('kDateCancel');
          const close=()=>{ if(kDateModal) kDateModal.classList.add('hidden'); };
          if(ok){ ok.onclick=()=>{ const dd=(d&&d.value)||''; const mm=(m&&m.value)||''; const txt=(dd&&mm)? \`\${dd}.\${mm}\`: (dd||mm||''); dateBtn.textContent= txt||'Tag.Monat'; dateBtn.dataset.value = txt; close(); }; }
          if(cancel){ cancel.onclick=()=>close(); }
          const closeOnEsc=(e)=>{ if(e.key==='Escape'){ close(); document.removeEventListener('keydown', closeOnEsc); } };
          document.addEventListener('keydown', closeOnEsc);
        });
      }
    }

  </script>
</body>
</html>
